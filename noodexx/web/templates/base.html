<!DOCTYPE html>
<html lang="en" x-data="{ darkMode: {{.DarkMode}} }" :class="{ 'dark': darkMode }">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Noodexx - Personal AI-powered knowledge base with RAG">
    <meta name="author" content="Noodexx">
    <title>Noodexx - {{.Title}}</title>
    <link rel="stylesheet" href="/static/style.css">
    
    <!-- Tailwind CSS with CDN fallback -->
    <script 
        src="https://cdn.tailwindcss.com" 
        onerror="console.log('Tailwind CSS CDN failed, loading from local static'); var script = document.createElement('script'); script.src = '/static/tailwind.min.js'; document.head.appendChild(script);">
    </script>
    
    <!-- Tailwind CSS Configuration -->
    {{if .UIStyle}}
    <script nonce="{{.Nonce}}">
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {{.UIStyle.Colors.Primary | toJSON}},
                        secondary: {{.UIStyle.Colors.Secondary | toJSON}},
                        success: {{.UIStyle.Colors.Success | toJSON}},
                        warning: {{.UIStyle.Colors.Warning | toJSON}},
                        error: {{.UIStyle.Colors.Error | toJSON}},
                        info: {{.UIStyle.Colors.Info | toJSON}},
                        surface: {{.UIStyle.Colors.Surface | toJSON}}
                    },
                    fontFamily: {{.UIStyle.Typography.FontFamily | toJSON}},
                    fontSize: {{.UIStyle.Typography.FontSizes | toJSON}},
                    borderRadius: {{.UIStyle.BorderRadius | toJSON}},
                    boxShadow: {{.UIStyle.Shadows | toJSON}}
                }
            }
        }
    </script>
    {{end}}
    
    <!-- Alpine.js with CDN fallback -->
    <script 
        defer 
        src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.5/dist/cdn.min.js" 
        onerror="console.log('Alpine.js CDN failed, loading from local static'); var script = document.createElement('script'); script.defer = true; script.src = '/static/alpine.min.js'; document.head.appendChild(script);">
    </script>
</head>
<body>
    <div class="flex min-h-screen">
        <!-- Sidebar Navigation -->
        <nav 
            id="sidebar" 
            class="w-64 bg-surface-50 dark:bg-surface-900 border-r border-surface-200 dark:border-surface-700 flex flex-col transition-all duration-300 relative z-50"
            x-data="{ 
                collapsed: false,
                init() {
                    try {
                        this.collapsed = localStorage.getItem('sidebarCollapsed') === 'true';
                    } catch (e) {
                        console.log('localStorage unavailable, using in-memory state for sidebar');
                        this.collapsed = false;
                    }
                }
            }"
            :class="{ 'w-16': collapsed, 'w-64': !collapsed }"
        >
            <!-- Sidebar Header -->
            <div class="flex items-center justify-between p-6 border-b border-surface-200 dark:border-surface-700">
                <div class="flex items-center gap-3">
                    <img src="/static/logo.png" alt="Noodexx Logo" class="flex-shrink-0" width="32" height="32">
                    <span 
                        class="text-xl font-semibold text-surface-900 dark:text-surface-100 whitespace-nowrap transition-opacity duration-150"
                        x-show="!collapsed"
                        x-transition:enter="transition ease-out duration-150"
                        x-transition:enter-start="opacity-0"
                        x-transition:enter-end="opacity-100"
                        x-transition:leave="transition ease-in duration-150"
                        x-transition:leave-start="opacity-100"
                        x-transition:leave-end="opacity-0"
                    >Noodexx</span>
                </div>
                <div class="flex gap-2 items-center">
                    <!-- Dark Mode Toggle Button -->
                    <button 
                        @click="darkMode = !darkMode; fetch('/api/user/preferences', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ dark_mode: darkMode }) }).catch(err => console.error('Failed to save dark mode:', err))"
                        class="p-2 rounded-lg hover:bg-surface-100 dark:hover:bg-surface-800 transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500 focus-visible:ring-offset-2 dark:focus-visible:ring-offset-surface-900"
                        aria-label="Toggle dark mode"
                    >
                        <!-- Moon icon (shown in light mode) -->
                        <svg x-show="!darkMode" class="w-5 h-5 text-surface-600 dark:text-surface-400" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/>
                        </svg>
                        <!-- Sun icon (shown in dark mode) -->
                        <svg x-show="darkMode" class="w-5 h-5 text-surface-600 dark:text-surface-400" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                    <!-- Sidebar Toggle Button -->
                    <button 
                        @click="collapsed = !collapsed; try { localStorage.setItem('sidebarCollapsed', collapsed); } catch (e) { console.log('localStorage unavailable, state will not persist'); }"
                        class="p-2 rounded-lg hover:bg-surface-100 dark:hover:bg-surface-800 transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500 focus-visible:ring-offset-2 dark:focus-visible:ring-offset-surface-900"
                        aria-label="Toggle sidebar"
                    >
                        <svg class="w-5 h-5 text-surface-600 dark:text-surface-400" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- User Menu (Multi-User Mode) -->
            {{if .UserMode}}
            {{if eq .UserMode "multi"}}
            {{if .CurrentUser}}
            <div class="relative" x-data="{ open: false }" @click.away="open = false">
                <button 
                    @click="open = !open"
                    class="w-full flex items-center gap-3 p-4 hover:bg-surface-100 dark:hover:bg-surface-800 transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-inset focus-visible:ring-primary-500"
                    aria-label="User menu"
                    aria-expanded="false"
                    :aria-expanded="open.toString()"
                >
                    <svg class="w-5 h-5 flex-shrink-0 text-surface-600 dark:text-surface-400" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/>
                    </svg>
                    <span 
                        class="flex-1 text-left text-sm font-medium text-surface-900 dark:text-surface-100 whitespace-nowrap"
                        x-show="!collapsed"
                        x-transition
                    >{{.CurrentUser.Username}}</span>
                    <svg 
                        class="w-4 h-4 text-surface-600 dark:text-surface-400 transition-transform"
                        :class="{ 'rotate-180': open }"
                        x-show="!collapsed"
                        x-transition
                        width="16" height="16" viewBox="0 0 20 20" fill="currentColor"
                    >
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                    </svg>
                </button>
                <!-- Dropdown Menu -->
                <div 
                    x-show="open"
                    x-transition:enter="transition ease-out duration-100"
                    x-transition:enter-start="transform opacity-0 scale-95"
                    x-transition:enter-end="transform opacity-100 scale-100"
                    x-transition:leave="transition ease-in duration-75"
                    x-transition:leave-start="transform opacity-100 scale-100"
                    x-transition:leave-end="transform opacity-0 scale-95"
                    class="absolute left-0 right-0 mx-2 mt-1 bg-white dark:bg-surface-800 rounded-lg shadow-lg border border-surface-200 dark:border-surface-700 py-1 z-50"
                    style="display: none;"
                >
                    <a 
                        href="/settings" 
                        class="flex items-center gap-3 px-4 py-2 text-sm text-surface-700 dark:text-surface-300 hover:bg-surface-100 dark:hover:bg-surface-700 transition-colors focus:outline-none focus-visible:bg-surface-100 dark:focus-visible:bg-surface-700"
                    >
                        <svg class="w-4 h-4" width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z"/>
                        </svg>
                        Settings
                    </a>
                    {{if .CurrentUser.IsAdmin}}
                    <a 
                        href="/settings#user-management" 
                        class="flex items-center gap-3 px-4 py-2 text-sm text-surface-700 dark:text-surface-300 hover:bg-surface-100 dark:hover:bg-surface-700 transition-colors focus:outline-none focus-visible:bg-surface-100 dark:focus-visible:bg-surface-700"
                    >
                        <svg class="w-4 h-4" width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                        </svg>
                        User Management
                    </a>
                    {{end}}
                    <div class="my-1 border-t border-surface-200 dark:border-surface-700"></div>
                    <button 
                        onclick="logoutFromMenu()"
                        class="w-full flex items-center gap-3 px-4 py-2 text-sm text-surface-700 dark:text-surface-300 hover:bg-surface-100 dark:hover:bg-surface-700 transition-colors focus:outline-none focus-visible:bg-surface-100 dark:focus-visible:bg-surface-700"
                    >
                        <svg class="w-4 h-4" width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z"/>
                        </svg>
                        Logout
                    </button>
                </div>
            </div>
            {{end}}
            {{end}}
            {{end}}

            <!-- Navigation Links -->
            <ul class="flex-1 list-none p-2 space-y-1">
                <li>
                    <a 
                        href="/" 
                        class="flex items-center gap-3 px-4 py-3 rounded-lg text-surface-600 dark:text-surface-400 hover:bg-surface-100 dark:hover:bg-surface-800 hover:text-surface-900 dark:hover:text-surface-100 transition-all duration-150 font-medium focus:outline-none focus-visible:ring-2 focus-visible:ring-inset focus-visible:ring-primary-500 {{if eq .Page "dashboard"}}bg-primary-50 dark:bg-primary-900/20 text-primary-600 dark:text-primary-400{{end}}" 
                        data-page="dashboard" 
                        onclick="return forceNavigate(event, '/')"
                    >
                        <svg class="w-5 h-5 flex-shrink-0" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                        </svg>
                        <span 
                            class="whitespace-nowrap"
                            x-show="!collapsed"
                            x-transition
                        >Dashboard</span>
                    </a>
                </li>
                <li>
                    <a 
                        href="/chat" 
                        class="flex items-center gap-3 px-4 py-3 rounded-lg text-surface-600 dark:text-surface-400 hover:bg-surface-100 dark:hover:bg-surface-800 hover:text-surface-900 dark:hover:text-surface-100 transition-all duration-150 font-medium focus:outline-none focus-visible:ring-2 focus-visible:ring-inset focus-visible:ring-primary-500 {{if eq .Page "chat"}}bg-primary-50 dark:bg-primary-900/20 text-primary-600 dark:text-primary-400{{end}}" 
                        data-page="chat" 
                        onclick="return forceNavigate(event, '/chat')"
                    >
                        <svg class="w-5 h-5 flex-shrink-0 chat-icon" id="chatNavIcon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z"/>
                        </svg>
                        <span 
                            class="whitespace-nowrap"
                            x-show="!collapsed"
                            x-transition
                        >Chat</span>
                    </a>
                </li>
                <li>
                    <a 
                        href="/library" 
                        class="flex items-center gap-3 px-4 py-3 rounded-lg text-surface-600 dark:text-surface-400 hover:bg-surface-100 dark:hover:bg-surface-800 hover:text-surface-900 dark:hover:text-surface-100 transition-all duration-150 font-medium focus:outline-none focus-visible:ring-2 focus-visible:ring-inset focus-visible:ring-primary-500 {{if eq .Page "library"}}bg-primary-50 dark:bg-primary-900/20 text-primary-600 dark:text-primary-400{{end}}" 
                        data-page="library" 
                        onclick="return forceNavigate(event, '/library')"
                    >
                        <svg class="w-5 h-5 flex-shrink-0" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"/>
                        </svg>
                        <span 
                            class="whitespace-nowrap"
                            x-show="!collapsed"
                            x-transition
                        >Library</span>
                    </a>
                </li>
                <li>
                    <a 
                        href="/settings" 
                        class="flex items-center gap-3 px-4 py-3 rounded-lg text-surface-600 dark:text-surface-400 hover:bg-surface-100 dark:hover:bg-surface-800 hover:text-surface-900 dark:hover:text-surface-100 transition-all duration-150 font-medium focus:outline-none focus-visible:ring-2 focus-visible:ring-inset focus-visible:ring-primary-500 {{if eq .Page "settings"}}bg-primary-50 dark:bg-primary-900/20 text-primary-600 dark:text-primary-400{{end}}" 
                        data-page="settings" 
                        onclick="return forceNavigate(event, '/settings')"
                    >
                        <svg class="w-5 h-5 flex-shrink-0" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z"/>
                        </svg>
                        <span 
                            class="whitespace-nowrap"
                            x-show="!collapsed"
                            x-transition
                        >Settings</span>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-auto bg-white dark:bg-surface-800">
            {{if eq .Page "dashboard"}}
                {{template "dashboard-content" .}}
            {{else if eq .Page "chat"}}
                {{template "chat-content" .}}
            {{else if eq .Page "library"}}
                {{template "library-content" .}}
            {{else if eq .Page "settings"}}
                {{template "settings-content" .}}
            {{else}}
                {{template "dashboard-content" .}}
            {{end}}
        </main>
    </div>

    <!-- Toast Notification Container -->
    {{template "toast-container"}}

    <!-- Command Palette -->
    <div id="command-palette" class="command-palette hidden">
        <div class="command-palette-backdrop"></div>
        <div class="command-palette-content">
            <input 
                type="text" 
                id="command-input" 
                class="command-input" 
                placeholder="Type a command or search..."
                autocomplete="off"
            >
            <ul id="command-list" class="command-list"></ul>
        </div>
    </div>

    <!-- WebSocket Connection Script -->
    <script>
        // WebSocket connection with auto-reconnect
        let ws = null;
        let reconnectInterval = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 10;
        const reconnectDelay = 3000; // 3 seconds

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            try {
                ws = new WebSocket(wsUrl);
                
                ws.onopen = function() {
                    console.log('WebSocket connected');
                    reconnectAttempts = 0;
                    if (reconnectInterval) {
                        clearInterval(reconnectInterval);
                        reconnectInterval = null;
                    }
                };
                
                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    } catch (e) {
                        console.error('Failed to parse WebSocket message:', e);
                    }
                };
                
                ws.onerror = function(error) {
                    console.error('WebSocket error:', error);
                };
                
                ws.onclose = function() {
                    console.log('WebSocket disconnected');
                    ws = null;
                    
                    // Attempt to reconnect
                    if (reconnectAttempts < maxReconnectAttempts && !reconnectInterval) {
                        reconnectInterval = setInterval(function() {
                            reconnectAttempts++;
                            console.log(`Reconnecting... (attempt ${reconnectAttempts}/${maxReconnectAttempts})`);
                            connectWebSocket();
                        }, reconnectDelay);
                    }
                };
            } catch (e) {
                console.error('Failed to create WebSocket:', e);
            }
        }

        function handleWebSocketMessage(data) {
            // Handle different message types
            switch(data.type) {
                case 'ingestion_complete':
                    if (typeof showToast === 'function') {
                        showToast('Document ingested successfully', 'success');
                    }
                    // Refresh library if on library page
                    if (window.location.pathname === '/library') {
                        if (typeof htmx !== 'undefined') {
                            htmx.trigger('#library-grid', 'refresh');
                        }
                    }
                    break;
                case 'deletion_complete':
                    if (typeof showToast === 'function') {
                        showToast('Document deleted', 'info');
                    }
                    break;
                case 'error':
                    if (typeof showToast === 'function') {
                        showToast(data.message || 'An error occurred', 'error');
                    }
                    break;
                default:
                    console.log('Unknown WebSocket message type:', data.type);
            }
        }

        // Initialize WebSocket connection on page load
        connectWebSocket();

        // HTMX event listener for toast notifications
        // Handles HX-Trigger headers from backend responses
        document.body.addEventListener('htmx:afterRequest', function(event) {
            // Check if the response has HX-Trigger header with toast data
            const triggerHeader = event.detail.xhr.getResponseHeader('HX-Trigger');
            if (triggerHeader) {
                try {
                    const triggers = JSON.parse(triggerHeader);
                    if (triggers.toast) {
                        // Dispatch toast event for Alpine.js toast manager
                        window.dispatchEvent(new CustomEvent('toast', { 
                            detail: triggers.toast 
                        }));
                    }
                } catch (e) {
                    console.error('Failed to parse HX-Trigger header:', e);
                }
            }
        });

        // Toggle dark mode function for Alpine.js
        function toggleDarkMode() {
            // Get current Alpine.js component
            const alpineData = Alpine.$data(document.documentElement);
            if (!alpineData) {
                console.error('Alpine.js not initialized');
                return;
            }
            
            // Store current state for potential revert
            const previousMode = alpineData.darkMode;
            
            // Toggle the mode locally for immediate UI feedback
            alpineData.darkMode = !previousMode;
            
            // Persist to backend (user profile in database)
            fetch('/api/user/preferences', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ dark_mode: alpineData.darkMode })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to save preference');
                }
                return response.json();
            })
            .then(data => {
                console.log('Dark mode preference saved:', alpineData.darkMode);
            })
            .catch(error => {
                console.error('Failed to save dark mode preference:', error);
                
                // Revert on error
                alpineData.darkMode = previousMode;
                
                // Show error toast
                window.dispatchEvent(new CustomEvent('toast', { 
                    detail: { 
                        variant: 'error', 
                        message: 'Failed to save dark mode preference' 
                    } 
                }));
            });
        }
        
        // Make toggleDarkMode globally available for Alpine.js
        window.toggleDarkMode = toggleDarkMode;

        // Initialize chat icon color based on privacy mode
        document.addEventListener('DOMContentLoaded', function() {
            const checkbox = document.getElementById('privacyModeToggle');
            const chatIcon = document.getElementById('chatNavIcon');
            if (checkbox && chatIcon) {
                const isEnabled = checkbox.checked;
                chatIcon.classList.add(isEnabled ? 'local-mode' : 'cloud-mode');
            }
        });

        // Force navigation function to bypass browser cache
        function forceNavigate(event, url) {
            event.preventDefault();
            console.log('Force navigating to:', url);
            // Add timestamp to force reload
            const timestamp = new Date().getTime();
            const separator = url.includes('?') ? '&' : '?';
            window.location.href = url + separator + '_t=' + timestamp;
            return false;
        }
        
        // Make it globally available
        window.forceNavigate = forceNavigate;

        // Logout from user menu
        async function logoutFromMenu() {
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    window.location.href = '/login';
                } else {
                    console.error('Logout failed');
                    alert('Failed to logout. Please try again.');
                }
            } catch (error) {
                console.error('Logout error:', error);
                alert('Failed to logout. Please try again.');
            }
        }

        // Initialize chat icon color based on privacy mode
        document.addEventListener('DOMContentLoaded', function() {
            const checkbox = document.getElementById('privacyModeToggle');
            const chatIcon = document.getElementById('chatNavIcon');
            if (checkbox && chatIcon) {
                const isEnabled = checkbox.checked;
                chatIcon.classList.add(isEnabled ? 'local-mode' : 'cloud-mode');
            }
        });
    </script>

    <!-- HTMX and App Scripts -->
    <script src="/static/htmx.min.js"></script>
    <script src="/static/app.js"></script>
</body>
</html>
