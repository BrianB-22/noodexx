{{define "chat-content"}}
<div class="chat-container">
    <!-- Session Sidebar -->
    <aside class="session-sidebar">
        <div class="session-header">
            <button class="btn-primary" id="newChatBtn" onclick="newChat()">
                <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"/>
                </svg>
                New Chat
            </button>
        </div>
        
        <div class="session-list" 
             hx-get="/api/sessions" 
             hx-trigger="load, refresh from:body"
             hx-swap="innerHTML">
            <!-- Sessions will be loaded here via HTMX -->
            <div class="session-loading">Loading sessions...</div>
        </div>
    </aside>

    <!-- Chat Area -->
    <div class="chat-main">
        <div class="messages-container" id="messagesContainer">
            <div class="welcome-message" id="welcomeMessage">
                <svg width="48" height="48" viewBox="0 0 20 20" fill="currentColor" style="opacity: 0.3;">
                    <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z"/>
                </svg>
                <h2>Start a conversation</h2>
                <p>Ask me anything about your documents or general questions.</p>
            </div>
            <!-- Messages will be added here dynamically -->
        </div>

        <!-- Chat Input Form -->
        <div class="chat-input-container">
            <form id="chatForm" onsubmit="sendMessage(event)">
                <div class="input-wrapper">
                    <textarea 
                        id="messageInput" 
                        class="chat-textarea" 
                        placeholder="Type your message... (Shift+Enter for new line, Enter to send)"
                        rows="1"
                        autofocus
                    ></textarea>
                    <button type="submit" class="btn-send" id="sendBtn" aria-label="Send message">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/>
                        </svg>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Current session ID
let currentSessionId = null;

// Initialize session on page load
document.addEventListener('DOMContentLoaded', function() {
    // Generate a new session ID for new chats
    currentSessionId = generateSessionId();
    
    // Auto-resize textarea
    const textarea = document.getElementById('messageInput');
    textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 200) + 'px';
    });
    
    // Handle Enter key (send) vs Shift+Enter (new line)
    textarea.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            document.getElementById('chatForm').dispatchEvent(new Event('submit'));
        }
    });
});

// Generate a unique session ID
function generateSessionId() {
    return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// Start a new chat session
function newChat() {
    currentSessionId = generateSessionId();
    const messagesContainer = document.getElementById('messagesContainer');
    messagesContainer.innerHTML = `
        <div class="welcome-message">
            <svg width="48" height="48" viewBox="0 0 20 20" fill="currentColor" style="opacity: 0.3;">
                <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z"/>
            </svg>
            <h2>Start a conversation</h2>
            <p>Ask me anything about your documents or general questions.</p>
        </div>
    `;
    document.getElementById('messageInput').value = '';
    document.getElementById('messageInput').focus();
    
    // Refresh session list
    if (typeof htmx !== 'undefined') {
        htmx.trigger('.session-list', 'refresh');
    }
}

// Load a specific session
function loadSession(sessionId) {
    currentSessionId = sessionId;
    const messagesContainer = document.getElementById('messagesContainer');
    
    // Show loading state
    messagesContainer.innerHTML = '<div class="message-loading">Loading conversation...</div>';
    
    // Fetch session history
    fetch('/api/sessions/' + sessionId)
        .then(response => response.text())
        .then(html => {
            messagesContainer.innerHTML = html;
            scrollToBottom();
        })
        .catch(error => {
            console.error('Failed to load session:', error);
            if (typeof showToast === 'function') {
                showToast('Failed to load conversation', 'error');
            }
            messagesContainer.innerHTML = '<div class="error-message">Failed to load conversation</div>';
        });
}

// Send a message
async function sendMessage(event) {
    event.preventDefault();
    
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) {
        return;
    }
    
    // Clear input and reset height
    input.value = '';
    input.style.height = 'auto';
    
    // Hide welcome message if present
    const welcomeMessage = document.getElementById('welcomeMessage');
    if (welcomeMessage) {
        welcomeMessage.remove();
    }
    
    // Add user message to UI
    addMessage('user', message);
    
    // Disable input while processing
    input.disabled = true;
    document.getElementById('sendBtn').disabled = true;
    
    // Add assistant message placeholder
    const assistantMessageId = 'msg_' + Date.now();
    addMessage('assistant', '', assistantMessageId);
    
    try {
        // Stream response from server
        const response = await fetch('/api/ask', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                query: message,
                session_id: currentSessionId
            })
        });
        
        if (!response.ok) {
            throw new Error('Request failed: ' + response.statusText);
        }
        
        // Read the streaming response
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let assistantMessage = '';
        
        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            const chunk = decoder.decode(value, { stream: true });
            assistantMessage += chunk;
            
            // Update the assistant message in real-time
            updateMessage(assistantMessageId, assistantMessage);
        }
        
        // Refresh session list to show updated timestamp
        if (typeof htmx !== 'undefined') {
            htmx.trigger('.session-list', 'refresh');
        }
        
    } catch (error) {
        console.error('Failed to send message:', error);
        updateMessage(assistantMessageId, 'Sorry, I encountered an error processing your request.');
        if (typeof showToast === 'function') {
            showToast('Failed to send message', 'error');
        }
    } finally {
        // Re-enable input
        input.disabled = false;
        document.getElementById('sendBtn').disabled = false;
        input.focus();
    }
}

// Add a message to the chat
function addMessage(role, content, messageId) {
    const messagesContainer = document.getElementById('messagesContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message message-' + role;
    if (messageId) {
        messageDiv.id = messageId;
    }
    
    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    
    if (role === 'user') {
        avatar.innerHTML = `
            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/>
            </svg>
        `;
    } else {
        avatar.innerHTML = `
            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                <path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z"/>
                <path d="M15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c.28.149.599.233.938.233h2l3 3v-3h2a2 2 0 002-2V9a2 2 0 00-2-2h-1z"/>
            </svg>
        `;
    }
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    
    if (role === 'assistant') {
        // For assistant messages, render as HTML (server-side markdown rendering)
        contentDiv.innerHTML = content || '<span class="typing-indicator">●●●</span>';
        
        // Add copy button for assistant messages
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'message-actions';
        actionsDiv.innerHTML = `
            <button class="btn-icon" onclick="copyMessage(this)" title="Copy message">
                <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"/>
                    <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"/>
                </svg>
            </button>
        `;
        contentDiv.appendChild(actionsDiv);
    } else {
        // For user messages, use text content
        contentDiv.textContent = content;
    }
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(contentDiv);
    messagesContainer.appendChild(messageDiv);
    
    scrollToBottom();
}

// Update an existing message
function updateMessage(messageId, content) {
    const messageDiv = document.getElementById(messageId);
    if (messageDiv) {
        const contentDiv = messageDiv.querySelector('.message-content');
        if (contentDiv) {
            // Remove typing indicator if present
            const typingIndicator = contentDiv.querySelector('.typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
            
            // Update content (preserve the actions div)
            const actionsDiv = contentDiv.querySelector('.message-actions');
            contentDiv.innerHTML = content;
            if (actionsDiv) {
                contentDiv.appendChild(actionsDiv);
            }
            
            scrollToBottom();
        }
    }
}

// Copy message to clipboard
function copyMessage(button) {
    const messageContent = button.closest('.message-content');
    const actionsDiv = messageContent.querySelector('.message-actions');
    
    // Clone the content and remove the actions div
    const clone = messageContent.cloneNode(true);
    const cloneActions = clone.querySelector('.message-actions');
    if (cloneActions) {
        cloneActions.remove();
    }
    
    const text = clone.textContent.trim();
    
    navigator.clipboard.writeText(text).then(() => {
        if (typeof showToast === 'function') {
            showToast('Message copied to clipboard', 'success');
        }
        
        // Visual feedback
        const originalIcon = button.innerHTML;
        button.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/>
            </svg>
        `;
        setTimeout(() => {
            button.innerHTML = originalIcon;
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy:', err);
        if (typeof showToast === 'function') {
            showToast('Failed to copy message', 'error');
        }
    });
}

// Scroll to bottom of messages
function scrollToBottom() {
    const container = document.getElementById('messagesContainer');
    container.scrollTop = container.scrollHeight;
}
</script>

<style>
/* Chat Container Layout */
.chat-container {
    display: flex;
    height: calc(100vh - 2rem);
    gap: 1rem;
}

/* Session Sidebar */
.session-sidebar {
    width: 260px;
    background: var(--surface);
    border-radius: 8px;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    overflow: hidden;
}

.session-header {
    flex-shrink: 0;
}

.session-list {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.session-item {
    padding: 0.75rem;
    background: var(--background);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid transparent;
}

.session-item:hover {
    background: var(--hover);
    border-color: var(--primary);
}

.session-item.active {
    background: var(--primary-light);
    border-color: var(--primary);
}

.session-title {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text);
    margin-bottom: 0.25rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.session-time {
    font-size: 0.75rem;
    color: var(--text-secondary);
}

.session-loading, .message-loading {
    text-align: center;
    padding: 2rem;
    color: var(--text-secondary);
}

/* Chat Main Area */
.chat-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--surface);
    border-radius: 8px;
    overflow: hidden;
}

/* Messages Container */
.messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 2rem;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

/* Welcome Message */
.welcome-message {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-secondary);
}

.welcome-message h2 {
    margin: 1rem 0 0.5rem;
    color: var(--text);
}

.welcome-message p {
    margin: 0;
}

/* Message Styles */
.message {
    display: flex;
    gap: 1rem;
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message-avatar {
    flex-shrink: 0;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--primary-light);
    color: var(--primary);
}

.message-user .message-avatar {
    background: var(--secondary-light);
    color: var(--secondary);
}

.message-content {
    flex: 1;
    position: relative;
    line-height: 1.6;
    color: var(--text);
}

/* Assistant message styling for markdown */
.message-assistant .message-content {
    background: var(--background);
    padding: 1rem;
    border-radius: 8px;
}

.message-assistant .message-content code {
    background: var(--surface);
    padding: 0.2em 0.4em;
    border-radius: 3px;
    font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
    font-size: 0.875em;
}

.message-assistant .message-content pre {
    background: var(--surface);
    padding: 1rem;
    border-radius: 6px;
    overflow-x: auto;
    margin: 0.5rem 0;
}

.message-assistant .message-content pre code {
    background: none;
    padding: 0;
}

/* Message Actions */
.message-actions {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    opacity: 0;
    transition: opacity 0.2s;
}

.message-content:hover .message-actions {
    opacity: 1;
}

/* Typing Indicator */
.typing-indicator {
    display: inline-block;
    font-size: 1.5rem;
    letter-spacing: 0.2rem;
    animation: typing 1.4s infinite;
}

@keyframes typing {
    0%, 60%, 100% {
        opacity: 0.3;
    }
    30% {
        opacity: 1;
    }
}

/* Chat Input */
.chat-input-container {
    flex-shrink: 0;
    padding: 1rem;
    border-top: 1px solid var(--border);
    background: var(--surface);
}

.input-wrapper {
    display: flex;
    gap: 0.5rem;
    align-items: flex-end;
}

.chat-textarea {
    flex: 1;
    min-height: 44px;
    max-height: 200px;
    padding: 0.75rem;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--background);
    color: var(--text);
    font-family: inherit;
    font-size: 0.875rem;
    resize: none;
    overflow-y: auto;
}

.chat-textarea:focus {
    outline: none;
    border-color: var(--primary);
}

.chat-textarea:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.btn-send {
    flex-shrink: 0;
    width: 44px;
    height: 44px;
    border: none;
    border-radius: 8px;
    background: var(--primary);
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.btn-send:hover:not(:disabled) {
    background: var(--primary-dark);
    transform: translateY(-1px);
}

.btn-send:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* Error Message */
.error-message {
    text-align: center;
    padding: 2rem;
    color: var(--error);
}

/* Responsive Design */
@media (max-width: 768px) {
    .chat-container {
        flex-direction: column;
    }
    
    .session-sidebar {
        width: 100%;
        max-height: 200px;
    }
}
</style>
{{end}}
